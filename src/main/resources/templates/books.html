<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Управление книгами</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
    <h1>Управление книгами</h1>

    <!-- Форма фильтрации -->
    <form th:action="@{/books}" method="get" class="mb-4">
        <div class="row g-3">
            <div class="col-md-3">
                <input type="text" name="title" th:value="${param.title}" class="form-control" placeholder="Название">
            </div>
            <div class="col-md-3">
                <input type="text" name="brand" th:value="${param.brand}" class="form-control" placeholder="Бренд">
            </div>
            <div class="col-md-2">
                <input type="number" name="year" th:value="${param.year}" class="form-control" placeholder="Год">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Фильтр</button>
            </div>
            <div class="col-md-2">
                <a href="/books" class="btn btn-secondary w-100">Сброс</a>
            </div>
        </div>
    </form>

    <!-- Таблица книг -->
    <table class="table table-striped">
        <thead>
        <tr>
            <th>ID</th>
            <th>Название</th>
            <th>Бренд</th>
            <th>Год</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="book : ${books}">
            <td th:text="${book.id}"></td>
            <td th:text="${book.title}"></td>
            <td th:text="${book.brand}"></td>
            <td th:text="${book.year}"></td>
            <td>
                <a th:href="@{/api/books/{id}(id=${book.id})}" class="btn btn-info btn-sm">Просмотр</a>
                <a th:href="@{/api/books/{id}/edit(id=${book.id})}" class="btn btn-warning btn-sm">Редактировать</a>
                <form th:action="@{/api/books/{id}(id=${book.id})}" method="post" style="display:inline;">
                    <input type="hidden" name="_method" value="DELETE"/>
                    <button type="submit" class="btn btn-danger btn-sm">Удалить</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Пагинация -->
    <nav th:if="${totalPages > 1}">
        <ul class="pagination">
            <li class="page-item" th:each="page : ${#numbers.sequence(0, totalPages-1)}">
                <a th:href="@{/books(title=${param.title}, brand=${param.brand}, year=${param.year}, page=${page}, size=${param.size})}"
                   th:text="${page+1}"
                   th:class="${page == currentPage} ? 'page-link active' : 'page-link'"></a>
            </li>
        </ul>
    </nav>

    <!-- Форма добавления новой книги -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>Добавить новую книгу</h5>
        </div>
        <div class="card-body">
            <form id="bookForm" onsubmit="event.preventDefault(); createBook();">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="mb-3">
                    <label class="form-label">Название</label>
                    <input type="text" name="title" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Бренд</label>
                    <input type="text" name="brand" class="form-control">
                </div>

                <div class="mb-3">
                    <label class="form-label">Год</label>
                    <input type="number" name="year" class="form-control">
                </div>

                <div class="mb-3">
                    <label class="form-label">Наличие</label>
                    <input type="text" name="stock" class="form-control">
                </div>

                <div class="mb-3">
                    <label class="form-label">Цена</label>
                    <input type="number" name="price" class="form-control">
                </div>

                <button type="submit" class="btn btn-success">Добавить</button>
            </form>
        </div>
    </div>
</div>

<!-- В самом конце файла, перед </body> -->
<script th:inline="javascript">
    /*<![CDATA[*/
    function createBook() {
        const formData = {
            title: document.querySelector('#bookForm input[name="title"]').value,
            brand: document.querySelector('#bookForm input[name="brand"]').value,
            year: document.querySelector('#bookForm input[name="year"]').value,
            stock: document.querySelector('#bookForm input[name="stock"]').value,
            price: document.querySelector('#bookForm input[name="price"]').value
        };

        fetch('/api/books', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('#bookForm input[name="_csrf"]').value
            },
            body: JSON.stringify(formData)
        })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/books?success=Книга+успешно+добавлена';
                } else {
                    response.json().then(data => {
                        alert('Ошибка: ' + (data.message || 'Неизвестная ошибка'));
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка при отправке данных');
            });
    }
    /*]]>*/
</script>


</body>
</html>